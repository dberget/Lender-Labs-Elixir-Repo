defmodule SharkAttackWeb.EventController do
  use SharkAttackWeb, :controller
  require Logger

  def debug(conn, params) do
    event = Map.get(params, "_json") |> Jason.decode!()

    SharkAttack.Workers.LoanHandler.update_loan(event)

    conn
    |> json(%{message: "ok"})
  end

  def index(conn, params) do
    event = Map.get(params, "_json") |> List.first()

    # SharkAttack.Events.insert_loan_event(
    #   event["type"],
    #   event["source"],
    #   event
    # )

    SharkAttack.Workers.LoanHandler.update_loan(event)

    conn
    |> json(%{message: "ok"})
  end

  def purchase(conn, params) do
    SharkAttack.Users.create_user(%{address: params["transactionObject"]["meta"]["senderPK"]})

    conn
    |> json(%{message: "ok"})
  end

  # Example
  # Labs account sold into Bs6 tensor offer.
  # {"accountData":[{"account":"Labsrz67AZ3Z7zk76k8hWh38nZSsfgUn4VtSU6ZdWL3","nativeBalanceChange":905473720,"tokenBalanceChanges":[]},{"account":"4zdNGgAtFsW1cQgHqkiWyRsxaAgxrSRRynnuunxzjxue","nativeBalanceChange":9400000,"tokenBalanceChanges":[]},{"account":"6kwDPtyo9jWhYH1BTJ6RRWcf6yRzKFfBdz935GSzzugM","nativeBalanceChange":1447680,"tokenBalanceChanges":[]},{"account":"9KG1j5GFQ67z8MkNhbKFFwBPED1mzY9sxjAemn8tCenQ","nativeBalanceChange":0,"tokenBalanceChanges":[]},{"account":"BS61tv1KbsPhns3ppU8pmWozfReZjhxFL2MPhBdDWNEm","nativeBalanceChange":0,"tokenBalanceChanges":[]},{"account":"E4S7qpLDa4cKxJkX8iGuX9uGqWqu9DaCvNtemm3NXjz3","nativeBalanceChange":0,"tokenBalanceChanges":[]},{"account":"FrZ6UuodANWfw8mMWBggDbQjrjnV8hcAaDVBUWRwwkAY","nativeBalanceChange":0,"tokenBalanceChanges":[]},{"account":"G4CNVrgAMvQmVve1AeCoLJHV6PtmpG9b618HL7M64TRs","nativeBalanceChange":6580000,"tokenBalanceChanges":[]},{"account":"GC53z7kzermMJuaMxzanbGUMmLG8dpg7GwrbpGpQBwdt","nativeBalanceChange":12502000,"tokenBalanceChanges":[]},{"account":"GR6d7LGRMmdupsu3enGyyg6uw2Mf6zsF357daKu9Emte","nativeBalanceChange":0,"tokenBalanceChanges":[]},{"account":"Gyw262iPBp7fzRNjoTuGZG5StEWEGgqyYiHeLD4xZFtR","nativeBalanceChange":0,"tokenBalanceChanges":[{"mint":"wADZCUJ3wEU39uYPemVH8ptan7epPNqkaaWedssPXbk","rawTokenAmount":{"decimals":0,"tokenAmount":"-1"},"tokenAccount":"Gyw262iPBp7fzRNjoTuGZG5StEWEGgqyYiHeLD4xZFtR","userAccount":"Labsrz67AZ3Z7zk76k8hWh38nZSsfgUn4VtSU6ZdWL3"}]},{"account":"H9AvUMwiBLCHoXXVvpm3Vtqxcg1w2qsHdxt29upspRDp","nativeBalanceChange":-1447680,"tokenBalanceChanges":[]},{"account":"tmbncMcYLSLpXFiF5YcQTyMKfp2DemorGSN4w77f5Km","nativeBalanceChange":2039280,"tokenBalanceChanges":[{"mint":"wADZCUJ3wEU39uYPemVH8ptan7epPNqkaaWedssPXbk","rawTokenAmount":{"decimals":0,"tokenAmount":"1"},"tokenAccount":"tmbncMcYLSLpXFiF5YcQTyMKfp2DemorGSN4w77f5Km","userAccount":"BS61tv1KbsPhns3ppU8pmWozfReZjhxFL2MPhBdDWNEm"}]},{"account":"XJTFhnuw8LbU1Tdj45wKh9SxUQpMywJ82rr8snjAGgj","nativeBalanceChange":-936240000,"tokenBalanceChanges":[]},{"account":"ysihRy7vfUR4uNdjKkYAVE4PFcVLu6RKJb43GDkH2My","nativeBalanceChange":0,"tokenBalanceChanges":[]},{"account":"11111111111111111111111111111111","nativeBalanceChange":0,"tokenBalanceChanges":[]},{"account":"9eHqk3waG1n9BmjuoW9wZ2CFbG6yLqiuWuGLARnxn2Xg","nativeBalanceChange":0,"tokenBalanceChanges":[]},{"account":"AdH2Utn6Fus15ZhtenW4hZBQnvtLgM1YCW2MfVp7pYS5","nativeBalanceChange":0,"tokenBalanceChanges":[]},{"account":"ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL","nativeBalanceChange":0,"tokenBalanceChanges":[]},{"account":"auth9SigNpDKz4sJJ1DfCTuZrZNSAgh9sFD3rboVmgg","nativeBalanceChange":0,"tokenBalanceChanges":[]},{"account":"ComputeBudget111111111111111111111111111111","nativeBalanceChange":0,"tokenBalanceChanges":[]},{"account":"DHszah8wZzYy4S91yabpma5y2yHDTfH9ai9nFUnF47Nh","nativeBalanceChange":0,"tokenBalanceChanges":[]},{"account":"DUS3iSV7WCgxJDjre7avcxFhUbybqt3DHG8auXTAkcw7","nativeBalanceChange":0,"tokenBalanceChanges":[]},{"account":"metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s","nativeBalanceChange":0,"tokenBalanceChanges":[]},{"account":"Sysvar1nstructions1111111111111111111111111","nativeBalanceChange":0,"tokenBalanceChanges":[]},{"account":"SysvarRent111111111111111111111111111111111","nativeBalanceChange":0,"tokenBalanceChanges":[]},{"account":"TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA","nativeBalanceChange":0,"tokenBalanceChanges":[]},{"account":"TSWAPaqyCSx2KABk68Shruf4rp7CxcNi8hAsbdwmHbN","nativeBalanceChange":0,"tokenBalanceChanges":[]},{"account":"wADZCUJ3wEU39uYPemVH8ptan7epPNqkaaWedssPXbk","nativeBalanceChange":0,"tokenBalanceChanges":[]}],"description":"Labsrz67AZ3Z7zk76k8hWh38nZSsfgUn4VtSU6ZdWL3 sold Lender Labs #4545 to BS61tv1KbsPhns3ppU8pmWozfReZjhxFL2MPhBdDWNEm for 0.94 SOL on TENSOR.","events":{"nft":{"amount":940000000,"buyer":"BS61tv1KbsPhns3ppU8pmWozfReZjhxFL2MPhBdDWNEm","description":"Labsrz67AZ3Z7zk76k8hWh38nZSsfgUn4VtSU6ZdWL3 sold Lender Labs #4545 to BS61tv1KbsPhns3ppU8pmWozfReZjhxFL2MPhBdDWNEm for 0.94 SOL on TENSOR.","fee":245000,"feePayer":"Labsrz67AZ3Z7zk76k8hWh38nZSsfgUn4VtSU6ZdWL3","nfts":[{"mint":"wADZCUJ3wEU39uYPemVH8ptan7epPNqkaaWedssPXbk","tokenStandard":"ProgrammableNonFungible"}],"saleType":"INSTANT_SALE","seller":"Labsrz67AZ3Z7zk76k8hWh38nZSsfgUn4VtSU6ZdWL3","signature":"3zFFqFq9jHW1dTLeFB9oPz9b38HetRvxsp4nou8ov9owwPdS4sSF8c5Cb9MutqMHAgR7NL1cYAFjZzxPZkDGRGc7","slot":217535768,"source":"TENSOR","staker":"","timestamp":1694706155,"type":"NFT_SALE"}},"fee":245000,"feePayer":"Labsrz67AZ3Z7zk76k8hWh38nZSsfgUn4VtSU6ZdWL3","instructions":[{"accounts":[],"data":"HNHdmh","innerInstructions":[],"programId":"ComputeBudget111111111111111111111111111111"},{"accounts":[],"data":"3QAwFKa3MJAs","innerInstructions":[],"programId":"ComputeBudget111111111111111111111111111111"},{"accounts":["4zdNGgAtFsW1cQgHqkiWyRsxaAgxrSRRynnuunxzjxue","4zdNGgAtFsW1cQgHqkiWyRsxaAgxrSRRynnuunxzjxue","ysihRy7vfUR4uNdjKkYAVE4PFcVLu6RKJb43GDkH2My","DHszah8wZzYy4S91yabpma5y2yHDTfH9ai9nFUnF47Nh","DUS3iSV7WCgxJDjre7avcxFhUbybqt3DHG8auXTAkcw7","Gyw262iPBp7fzRNjoTuGZG5StEWEGgqyYiHeLD4xZFtR","wADZCUJ3wEU39uYPemVH8ptan7epPNqkaaWedssPXbk","9KG1j5GFQ67z8MkNhbKFFwBPED1mzY9sxjAemn8tCenQ","XJTFhnuw8LbU1Tdj45wKh9SxUQpMywJ82rr8snjAGgj","BS61tv1KbsPhns3ppU8pmWozfReZjhxFL2MPhBdDWNEm","Labsrz67AZ3Z7zk76k8hWh38nZSsfgUn4VtSU6ZdWL3","tmbncMcYLSLpXFiF5YcQTyMKfp2DemorGSN4w77f5Km","TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA","ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL","11111111111111111111111111111111","SysvarRent111111111111111111111111111111111","9eHqk3waG1n9BmjuoW9wZ2CFbG6yLqiuWuGLARnxn2Xg","H9AvUMwiBLCHoXXVvpm3Vtqxcg1w2qsHdxt29upspRDp","6kwDPtyo9jWhYH1BTJ6RRWcf6yRzKFfBdz935GSzzugM","metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s","Sysvar1nstructions1111111111111111111111111","auth9SigNpDKz4sJJ1DfCTuZrZNSAgh9sFD3rboVmgg","E4S7qpLDa4cKxJkX8iGuX9uGqWqu9DaCvNtemm3NXjz3","GR6d7LGRMmdupsu3enGyyg6uw2Mf6zsF357daKu9Emte","AdH2Utn6Fus15ZhtenW4hZBQnvtLgM1YCW2MfVp7pYS5","Labsrz67AZ3Z7zk76k8hWh38nZSsfgUn4VtSU6ZdWL3","4zdNGgAtFsW1cQgHqkiWyRsxaAgxrSRRynnuunxzjxue","FrZ6UuodANWfw8mMWBggDbQjrjnV8hcAaDVBUWRwwkAY","Labsrz67AZ3Z7zk76k8hWh38nZSsfgUn4VtSU6ZdWL3","GC53z7kzermMJuaMxzanbGUMmLG8dpg7GwrbpGpQBwdt","G4CNVrgAMvQmVve1AeCoLJHV6PtmpG9b618HL7M64TRs"],"data":"DYGGjo874uQrAgzBPny4NJmT92A2J4trEnapSsnQjTc8pSUDwLozaXt3","innerInstructions":[{"accounts":["Labsrz67AZ3Z7zk76k8hWh38nZSsfgUn4VtSU6ZdWL3","tmbncMcYLSLpXFiF5YcQTyMKfp2DemorGSN4w77f5Km","BS61tv1KbsPhns3ppU8pmWozfReZjhxFL2MPhBdDWNEm","wADZCUJ3wEU39uYPemVH8ptan7epPNqkaaWedssPXbk","11111111111111111111111111111111","TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA"],"data":"1","programId":"ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL"},{"accounts":["wADZCUJ3wEU39uYPemVH8ptan7epPNqkaaWedssPXbk"],"data":"84eT","programId":"TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA"},{"accounts":["Labsrz67AZ3Z7zk76k8hWh38nZSsfgUn4VtSU6ZdWL3","tmbncMcYLSLpXFiF5YcQTyMKfp2DemorGSN4w77f5Km"],"data":"11119os1e9qSs2u7TsThXqkBSRVFxhmYaFKFZ1waB2X7armDmvK3p5GmLdUxYdg3h7QSrL","programId":"11111111111111111111111111111111"},{"accounts":["tmbncMcYLSLpXFiF5YcQTyMKfp2DemorGSN4w77f5Km"],"data":"P","programId":"TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA"},{"accounts":["tmbncMcYLSLpXFiF5YcQTyMKfp2DemorGSN4w77f5Km","wADZCUJ3wEU39uYPemVH8ptan7epPNqkaaWedssPXbk"],"data":"6XZngq7Y7tifY4M9LudLAFVFPAKEP9TDx2wXFBmK2oWfj","programId":"TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA"},{"accounts":["Labsrz67AZ3Z7zk76k8hWh38nZSsfgUn4VtSU6ZdWL3","E4S7qpLDa4cKxJkX8iGuX9uGqWqu9DaCvNtemm3NXjz3"],"data":"11119os1e9qSs2u7TsThXqkBSRVFxhmYaFKFZ1waB2X7armDmvK3p5GmLdUxYdg3h7QSrL","programId":"11111111111111111111111111111111"},{"accounts":["E4S7qpLDa4cKxJkX8iGuX9uGqWqu9DaCvNtemm3NXjz3","wADZCUJ3wEU39uYPemVH8ptan7epPNqkaaWedssPXbk"],"data":"6R8L3CshgYimqstmovuurTQKM54GnGBh8ghxmQNep37Lc","programId":"TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA"},{"accounts":["Gyw262iPBp7fzRNjoTuGZG5StEWEGgqyYiHeLD4xZFtR","Labsrz67AZ3Z7zk76k8hWh38nZSsfgUn4VtSU6ZdWL3","E4S7qpLDa4cKxJkX8iGuX9uGqWqu9DaCvNtemm3NXjz3","4zdNGgAtFsW1cQgHqkiWyRsxaAgxrSRRynnuunxzjxue","wADZCUJ3wEU39uYPemVH8ptan7epPNqkaaWedssPXbk","9KG1j5GFQ67z8MkNhbKFFwBPED1mzY9sxjAemn8tCenQ","9eHqk3waG1n9BmjuoW9wZ2CFbG6yLqiuWuGLARnxn2Xg","H9AvUMwiBLCHoXXVvpm3Vtqxcg1w2qsHdxt29upspRDp","GR6d7LGRMmdupsu3enGyyg6uw2Mf6zsF357daKu9Emte","Labsrz67AZ3Z7zk76k8hWh38nZSsfgUn4VtSU6ZdWL3","Labsrz67AZ3Z7zk76k8hWh38nZSsfgUn4VtSU6ZdWL3","11111111111111111111111111111111","Sysvar1nstructions1111111111111111111111111","TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA","ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL","auth9SigNpDKz4sJJ1DfCTuZrZNSAgh9sFD3rboVmgg","AdH2Utn6Fus15ZhtenW4hZBQnvtLgM1YCW2MfVp7pYS5"],"data":"D9kCuD4PTuQuyCK","programId":"metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s"},{"accounts":["AdH2Utn6Fus15ZhtenW4hZBQnvtLgM1YCW2MfVp7pYS5","wADZCUJ3wEU39uYPemVH8ptan7epPNqkaaWedssPXbk","11111111111111111111111111111111","auth9SigNpDKz4sJJ1DfCTuZrZNSAgh9sFD3rboVmgg","auth9SigNpDKz4sJJ1DfCTuZrZNSAgh9sFD3rboVmgg","auth9SigNpDKz4sJJ1DfCTuZrZNSAgh9sFD3rboVmgg","Labsrz67AZ3Z7zk76k8hWh38nZSsfgUn4VtSU6ZdWL3","4zdNGgAtFsW1cQgHqkiWyRsxaAgxrSRRynnuunxzjxue","Labsrz67AZ3Z7zk76k8hWh38nZSsfgUn4VtSU6ZdWL3"],"data":"37XhgGsfB31PPTmbUpS1oTsKTkqvoe5tqU2UYE7gyHCWnzkmiptjQWww3jej29faoGi8GrNuDmNMiUWxa2gF4YXjEeFYKUcteSsAzPcsvdr4QPkW1EygYqp9rEGrg7AsVBiDax5DnrGY1MfU86azQBjhdFomp2ESAzNzyJjKWtGHV8VZZt3GMtCHMJGeg968S2VhbwxTnLmpoMbBEmt5xZmnijyAe8JKPMcc8UgeUohyx4pWFJ4egakP","programId":"auth9SigNpDKz4sJJ1DfCTuZrZNSAgh9sFD3rboVmgg"},{"accounts":["Gyw262iPBp7fzRNjoTuGZG5StEWEGgqyYiHeLD4xZFtR","wADZCUJ3wEU39uYPemVH8ptan7epPNqkaaWedssPXbk","9eHqk3waG1n9BmjuoW9wZ2CFbG6yLqiuWuGLARnxn2Xg"],"data":"C","programId":"TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA"},{"accounts":["Gyw262iPBp7fzRNjoTuGZG5StEWEGgqyYiHeLD4xZFtR","E4S7qpLDa4cKxJkX8iGuX9uGqWqu9DaCvNtemm3NXjz3","Labsrz67AZ3Z7zk76k8hWh38nZSsfgUn4VtSU6ZdWL3","Labsrz67AZ3Z7zk76k8hWh38nZSsfgUn4VtSU6ZdWL3"],"data":"3DdGGhkhJbjm","programId":"TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA"},{"accounts":["E4S7qpLDa4cKxJkX8iGuX9uGqWqu9DaCvNtemm3NXjz3","wADZCUJ3wEU39uYPemVH8ptan7epPNqkaaWedssPXbk","9eHqk3waG1n9BmjuoW9wZ2CFbG6yLqiuWuGLARnxn2Xg"],"data":"B","programId":"TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA"},{"accounts":["Labsrz67AZ3Z7zk76k8hWh38nZSsfgUn4VtSU6ZdWL3","GR6d7LGRMmdupsu3enGyyg6uw2Mf6zsF357daKu9Emte"],"data":"3Bxs3zsXzUzSwHyq","programId":"11111111111111111111111111111111"},{"accounts":["GR6d7LGRMmdupsu3enGyyg6uw2Mf6zsF357daKu9Emte"],"data":"9krTDDojp1psPDkb","programId":"11111111111111111111111111111111"},{"accounts":["GR6d7LGRMmdupsu3enGyyg6uw2Mf6zsF357daKu9Emte"],"data":"SYXsBkG6yKW2wWDcW8EDHR6D3P82bKxJGPpM65DD8nHqBfMP","programId":"11111111111111111111111111111111"},{"accounts":["E4S7qpLDa4cKxJkX8iGuX9uGqWqu9DaCvNtemm3NXjz3","4zdNGgAtFsW1cQgHqkiWyRsxaAgxrSRRynnuunxzjxue","tmbncMcYLSLpXFiF5YcQTyMKfp2DemorGSN4w77f5Km","BS61tv1KbsPhns3ppU8pmWozfReZjhxFL2MPhBdDWNEm","wADZCUJ3wEU39uYPemVH8ptan7epPNqkaaWedssPXbk","9KG1j5GFQ67z8MkNhbKFFwBPED1mzY9sxjAemn8tCenQ","9eHqk3waG1n9BmjuoW9wZ2CFbG6yLqiuWuGLARnxn2Xg","GR6d7LGRMmdupsu3enGyyg6uw2Mf6zsF357daKu9Emte","6kwDPtyo9jWhYH1BTJ6RRWcf6yRzKFfBdz935GSzzugM","4zdNGgAtFsW1cQgHqkiWyRsxaAgxrSRRynnuunxzjxue","Labsrz67AZ3Z7zk76k8hWh38nZSsfgUn4VtSU6ZdWL3","11111111111111111111111111111111","Sysvar1nstructions1111111111111111111111111","TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA","ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL","auth9SigNpDKz4sJJ1DfCTuZrZNSAgh9sFD3rboVmgg","AdH2Utn6Fus15ZhtenW4hZBQnvtLgM1YCW2MfVp7pYS5"],"data":"D9kCuD4PTuQuyCK","programId":"metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s"},{"accounts":["AdH2Utn6Fus15ZhtenW4hZBQnvtLgM1YCW2MfVp7pYS5","wADZCUJ3wEU39uYPemVH8ptan7epPNqkaaWedssPXbk","11111111111111111111111111111111","auth9SigNpDKz4sJJ1DfCTuZrZNSAgh9sFD3rboVmgg","auth9SigNpDKz4sJJ1DfCTuZrZNSAgh9sFD3rboVmgg","auth9SigNpDKz4sJJ1DfCTuZrZNSAgh9sFD3rboVmgg","4zdNGgAtFsW1cQgHqkiWyRsxaAgxrSRRynnuunxzjxue","BS61tv1KbsPhns3ppU8pmWozfReZjhxFL2MPhBdDWNEm","4zdNGgAtFsW1cQgHqkiWyRsxaAgxrSRRynnuunxzjxue"],"data":"37XhgGsfB31PPTmbUpS1oTsKTkqvoe5tqU2UYE7gyHCWnzkmiptjQWww3jej29faoGi8GrNuDmNMiYGRhyABoPHitxQ7xEKpkbaNV9TzAteJUBxYiH1BcHRtSN3E3RwpnDpymjLGkT2ydRYeEBSHZNJgEniQAeAVbHF71qfufKkM7JchGWMENWqB81PnGdFuAGyMQup5wgTLeKemhvmo7SGhGfPjwy1391si61LixwfoAGCuiZgYazXy","programId":"auth9SigNpDKz4sJJ1DfCTuZrZNSAgh9sFD3rboVmgg"},{"accounts":["E4S7qpLDa4cKxJkX8iGuX9uGqWqu9DaCvNtemm3NXjz3","wADZCUJ3wEU39uYPemVH8ptan7epPNqkaaWedssPXbk","9eHqk3waG1n9BmjuoW9wZ2CFbG6yLqiuWuGLARnxn2Xg"],"data":"C","programId":"TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA"},{"accounts":["E4S7qpLDa4cKxJkX8iGuX9uGqWqu9DaCvNtemm3NXjz3","tmbncMcYLSLpXFiF5YcQTyMKfp2DemorGSN4w77f5Km","4zdNGgAtFsW1cQgHqkiWyRsxaAgxrSRRynnuunxzjxue","4zdNGgAtFsW1cQgHqkiWyRsxaAgxrSRRynnuunxzjxue"],"data":"3DdGGhkhJbjm","programId":"TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA"},{"accounts":["tmbncMcYLSLpXFiF5YcQTyMKfp2DemorGSN4w77f5Km","wADZCUJ3wEU39uYPemVH8ptan7epPNqkaaWedssPXbk","9eHqk3waG1n9BmjuoW9wZ2CFbG6yLqiuWuGLARnxn2Xg"],"data":"B","programId":"TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA"},{"accounts":["Labsrz67AZ3Z7zk76k8hWh38nZSsfgUn4VtSU6ZdWL3","6kwDPtyo9jWhYH1BTJ6RRWcf6yRzKFfBdz935GSzzugM"],"data":"3Bxs3zsXzUzSwHyq","programId":"11111111111111111111111111111111"},{"accounts":["6kwDPtyo9jWhYH1BTJ6RRWcf6yRzKFfBdz935GSzzugM"],"data":"9krTDDojp1psPDkb","programId":"11111111111111111111111111111111"},{"accounts":["6kwDPtyo9jWhYH1BTJ6RRWcf6yRzKFfBdz935GSzzugM"],"data":"SYXsBkG6yKW2wWDcW8EDHR6D3P82bKxJGPpM65DD8nHqBfMP","programId":"11111111111111111111111111111111"},{"accounts":["E4S7qpLDa4cKxJkX8iGuX9uGqWqu9DaCvNtemm3NXjz3","Labsrz67AZ3Z7zk76k8hWh38nZSsfgUn4VtSU6ZdWL3","4zdNGgAtFsW1cQgHqkiWyRsxaAgxrSRRynnuunxzjxue"],"data":"A","programId":"TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA"}],"programId":"TSWAPaqyCSx2KABk68Shruf4rp7CxcNi8hAsbdwmHbN"}],"nativeTransfers":[{"amount":2039280,"fromUserAccount":"Labsrz67AZ3Z7zk76k8hWh38nZSsfgUn4VtSU6ZdWL3","toUserAccount":"tmbncMcYLSLpXFiF5YcQTyMKfp2DemorGSN4w77f5Km"},{"amount":2039280,"fromUserAccount":"Labsrz67AZ3Z7zk76k8hWh38nZSsfgUn4VtSU6ZdWL3","toUserAccount":"E4S7qpLDa4cKxJkX8iGuX9uGqWqu9DaCvNtemm3NXjz3"},{"amount":1447680,"fromUserAccount":"Labsrz67AZ3Z7zk76k8hWh38nZSsfgUn4VtSU6ZdWL3","toUserAccount":"GR6d7LGRMmdupsu3enGyyg6uw2Mf6zsF357daKu9Emte"},{"amount":1447680,"fromUserAccount":"Labsrz67AZ3Z7zk76k8hWh38nZSsfgUn4VtSU6ZdWL3","toUserAccount":"6kwDPtyo9jWhYH1BTJ6RRWcf6yRzKFfBdz935GSzzugM"},{"amount":2039280,"fromUserAccount":"E4S7qpLDa4cKxJkX8iGuX9uGqWqu9DaCvNtemm3NXjz3","toUserAccount":"Labsrz67AZ3Z7zk76k8hWh38nZSsfgUn4VtSU6ZdWL3"}],"signature":"3zFFqFq9jHW1dTLeFB9oPz9b38HetRvxsp4nou8ov9owwPdS4sSF8c5Cb9MutqMHAgR7NL1cYAFjZzxPZkDGRGc7","slot":217535768,"source":"TENSOR","timestamp":1694706155,"tokenTransfers":[{"fromTokenAccount":"Gyw262iPBp7fzRNjoTuGZG5StEWEGgqyYiHeLD4xZFtR","fromUserAccount":"Labsrz67AZ3Z7zk76k8hWh38nZSsfgUn4VtSU6ZdWL3","mint":"wADZCUJ3wEU39uYPemVH8ptan7epPNqkaaWedssPXbk","toTokenAccount":"E4S7qpLDa4cKxJkX8iGuX9uGqWqu9DaCvNtemm3NXjz3","toUserAccount":"4zdNGgAtFsW1cQgHqkiWyRsxaAgxrSRRynnuunxzjxue","tokenAmount":1,"tokenStandard":"ProgrammableNonFungible"},{"fromTokenAccount":"E4S7qpLDa4cKxJkX8iGuX9uGqWqu9DaCvNtemm3NXjz3","fromUserAccount":"4zdNGgAtFsW1cQgHqkiWyRsxaAgxrSRRynnuunxzjxue","mint":"wADZCUJ3wEU39uYPemVH8ptan7epPNqkaaWedssPXbk","toTokenAccount":"tmbncMcYLSLpXFiF5YcQTyMKfp2DemorGSN4w77f5Km","toUserAccount":"BS61tv1KbsPhns3ppU8pmWozfReZjhxFL2MPhBdDWNEm","tokenAmount":1,"tokenStandard":"ProgrammableNonFungible"}],"transactionError":null,"type":"NFT_SALE"}

  def nft(conn, params) do
    event = Map.get(params, "_json") |> List.first()

    purchased_mint =
      event["events"]["nft"]["nfts"] |> List.first() |> Map.get("mint") |> IO.inspect()

    SharkAttack.Events.insert_loan_event(
      event["type"],
      event["source"],
      event
    )

    conn
    |> json(%{mint: purchased_mint})
  end
end
